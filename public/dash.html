<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeValid Dashboard</title>
    <link rel="icon" type="image/png" href="/perfume_icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/perfume_icon.png" alt="WeValid" class="w-10 h-10 invert">
                    <div>
                        <h1 class="text-xl font-bold">WeValid Dashboard</h1>
                        <p class="text-sm text-purple-100" id="userInfo">Carregando...</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <a href="/import.html"
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                        Importar
                    </a>
                    <button onclick="logout()"
                        class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-all text-sm font-medium">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Franchise Filter (Admin only) -->
                <div id="franchiseFilterContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Franquia</label>
                    <select id="franchiseFilter" onchange="filterByFranchise()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Todas as Franquias</option>
                    </select>
                </div>

                <!-- Store Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Loja</label>
                    <select id="storeFilter" onchange="filterByStore()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Todas as Lojas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Funcionários</div>
                <div class="text-2xl font-bold text-purple-600" id="totalUsers">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Produtos</div>
                <div class="text-2xl font-bold text-blue-600" id="totalProducts">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Vencendo em 7 dias</div>
                <div class="text-2xl font-bold text-amber-600" id="expiringProducts">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Custo Total</div>
                <div class="text-2xl font-bold text-green-600" id="totalCost">R$ 0</div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Employees -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Funcionários</h2>
                </div>
                <div id="employeesList" class="p-4 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 py-8">Carregando...</p>
                </div>
            </div>

            <!-- Products -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Produtos por Validade</h2>
                </div>
                <div id="productsList" class="p-4 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 py-8">Carregando...</p>
                </div>
            </div>

            <!-- Category Ranking (New) -->
            <div class="bg-white rounded-lg shadow lg:col-span-2">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Ranking por Categoria</h2>
                </div>
                <div id="categoryRanking" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <p class="text-center text-gray-400 py-8 col-span-3">Carregando...</p>
                </div>
            </div>
        </div>

        <!-- Transfer Suggestions -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Sugestões de Transferência (Estoque)</h2>
                <p class="text-sm text-gray-500">Baseado em estoque baixo (< 5) vs alto (> 20)</p>
            </div>
            <div id="transferSuggestions" class="p-4">
                <p class="text-center text-gray-400 py-8">Carregando...</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://acensrxfxzqozakkklmy.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZW5zcnhmeHpxb3pha2trbG15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2ODc2NDUsImV4cCI6MjA3OTI2MzY0NX0.rRsWLCmIcoyKkE5Qh_et53wO_xzLriOjrsfU0Rs85Lo'
        );

        let currentUser = null;
        let currentProfile = null;
        let allFranchises = [];
        let allEmployees = [];
        let allProducts = [];
        let allStores = [];

        // Check auth
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/dash-login.html';
                return null;
            }
            return session.user;
        }

        // Logout
        window.logout = async function () {
            await supabase.auth.signOut();
            window.location.href = '/dash-login.html';
        };

        // Load initial data
        async function loadData() {
            currentUser = await checkAuth();
            if (!currentUser) return;

            const { data: profile, error: profileError } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (profileError) {
                console.error('Profile error:', profileError);
                alert('Erro ao carregar perfil: ' + profileError.message);
                return;
            }

            if (!profile) {
                alert('Perfil não encontrado');
                return;
            }

            currentProfile = profile;
            document.getElementById('userInfo').textContent = `${profile.full_name || profile.email} - ${getRoleName(profile.role)}`;

            // Admin: load all franchises
            if (profile.role === 'admin') {
                const { data: franchises } = await supabase
                    .from('franchises')
                    .select('*')
                    .order('name');

                allFranchises = franchises || [];
                populateFranchiseFilter();
                document.getElementById('franchiseFilterContainer').classList.remove('hidden');

                const { data: stores } = await supabase
                    .from('stores')
                    .select('*')
                    .order('name');
                allStores = stores || [];
            } else {
                // Manager/Store User: only their franchise stores
                if (!profile.franchise_id) {
                    alert('Usuário sem franquia associada');
                    return;
                }

                const { data: stores } = await supabase
                    .from('stores')
                    .select('*')
                    .eq('franchise_id', profile.franchise_id)
                    .order('name');
                allStores = stores || [];
            }

            populateStoreFilter();
            await loadDashboardData();
        }

        function getRoleName(role) {
            const names = { admin: 'Administrador', manager: 'Gestor', store_user: 'Operador' };
            return names[role] || role;
        }

        function populateFranchiseFilter() {
            const select = document.getElementById('franchiseFilter');
            select.innerHTML = '<option value="all">Todas as Franquias</option>';
            allFranchises.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.name;
                select.appendChild(option);
            });
        }

        function populateStoreFilter() {
            const select = document.getElementById('storeFilter');
            select.innerHTML = '<option value="all">Todas as Lojas</option>';
            allStores.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                select.appendChild(option);
            });
        }

        window.filterByFranchise = async function () {
            const selectedFranchise = document.getElementById('franchiseFilter').value;

            if (selectedFranchise === 'all') {
                const { data: stores } = await supabase.from('stores').select('*').order('name');
                allStores = stores || [];
            } else {
                const { data: stores } = await supabase
                    .from('stores')
                    .select('*')
                    .eq('franchise_id', selectedFranchise)
                    .order('name');
                allStores = stores || [];
            }

            populateStoreFilter();
            document.getElementById('storeFilter').value = 'all';
            await loadDashboardData();
        };

        window.filterByStore = async function () {
            updateDashboard();
        };

        async function loadDashboardData() {
            const selectedFranchise = currentProfile.role === 'admin'
                ? document.getElementById('franchiseFilter').value
                : currentProfile.franchise_id;

            let query = supabase.from('user_profiles').select('*, user_stores(stores(id, name))').eq('status', 'approved');
            if (selectedFranchise !== 'all') query = query.eq('franchise_id', selectedFranchise);
            const { data: employees } = await query;

            allEmployees = employees?.map(e => ({
                ...e,
                stores: e.user_stores?.map(us => us.stores) || []
            })) || [];

            query = supabase.from('inventory_items').select('*, products(description, category, unit_cost), stores(name)').order('expiry_date', { ascending: true });
            if (selectedFranchise !== 'all') query = query.eq('franchise_id', selectedFranchise);
            const { data: products } = await query;

            allProducts = products?.map(p => ({
                ...p,
                product_description: p.products?.description,
                category: p.products?.category,
                store_name: p.stores?.name
            })) || [];

            updateDashboard();
        }

        function updateDashboard() {
            const selectedStore = document.getElementById('storeFilter').value;
            let filteredEmployees = allEmployees;
            let filteredProducts = allProducts;

            if (selectedStore !== 'all') {
                filteredEmployees = allEmployees.filter(e =>
                    e.role === 'manager' || e.stores.some(s => s.id === selectedStore)
                );
                filteredProducts = allProducts.filter(p => p.store_id === selectedStore);
            }

            document.getElementById('totalUsers').textContent = filteredEmployees.length;
            document.getElementById('totalProducts').textContent = filteredProducts.length;

            const today = new Date();
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const expiring = filteredProducts.filter(p => {
                const expiryDate = new Date(p.expiry_date);
                return expiryDate >= today && expiryDate <= sevenDaysFromNow;
            });
            document.getElementById('expiringProducts').textContent = expiring.length;

            const totalCost = filteredProducts.reduce((sum, p) => sum + (p.total_cost || 0), 0);
            document.getElementById('totalCost').textContent = `R$ ${totalCost.toFixed(2)}`;

            renderEmployees(filteredEmployees);
            renderProducts(filteredProducts);
            renderCategoryRanking(filteredProducts);
            renderTransferSuggestions(allProducts);
        }

        function renderCategoryRanking(products) {
            const container = document.getElementById('categoryRanking');
            if (products.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8 col-span-3">Nenhum dado disponível</p>';
                return;
            }

            const categories = {};
            products.forEach(p => {
                const cat = p.category || 'Sem Categoria';
                if (!categories[cat]) categories[cat] = { count: 0, value: 0 };
                categories[cat].count += p.quantity || 0;
                categories[cat].value += (p.total_cost || 0);
            });

            const sortedCategories = Object.entries(categories)
                .sort(([, a], [, b]) => b.count - a.count)
                .slice(0, 6);

            container.innerHTML = sortedCategories.map(([name, data], index) => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-bold text-gray-600">#${index + 1} ${name}</span>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">${data.count} itens</span>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-semibold text-green-600">R$ ${data.value.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderEmployees(employees) {
            const container = document.getElementById('employeesList');
            if (employees.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhum funcionário encontrado</p>';
                return;
            }

            container.innerHTML = employees.map(emp => {
                const roleColors = { admin: 'bg-red-100 text-red-700', manager: 'bg-purple-100 text-purple-700', store_user: 'bg-blue-100 text-blue-700' };
                const storeNames = emp.role === 'manager' ? 'Todas as lojas' : emp.stores.map(s => s.name).join(', ') || 'Sem loja';

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                        <div>
                            <p class="font-semibold text-gray-800">${emp.full_name || 'Sem nome'}</p>
                            <p class="text-sm text-gray-500">${emp.email}</p>
                            <p class="text-xs text-gray-400">${storeNames}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${roleColors[emp.role]}">${getRoleName(emp.role)}</span>
                    </div>
                `;
            }).join('');
        }

        function renderProducts(products) {
            const container = document.getElementById('productsList');
            if (products.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhum produto encontrado</p>';
                return;
            }

            container.innerHTML = products.slice(0, 20).map(product => {
                const expiryDate = new Date(product.expiry_date);
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                let urgencyColor = 'text-green-600';
                if (daysUntilExpiry <= 7) urgencyColor = 'text-red-600 font-bold';
                else if (daysUntilExpiry <= 30) urgencyColor = 'text-amber-600';

                return `
                    <div class="p-3 bg-gray-50 rounded-lg mb-2">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${product.product_description || 'Sem descrição'}</p>
                                <p class="text-sm text-gray-500">${product.product_code} | ${product.store_name}</p>
                            </div>
                            <span class="text-lg font-bold text-gray-700">×${product.quantity}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="${urgencyColor}">${expiryDate.toLocaleDateString('pt-BR')} (${daysUntilExpiry}d)</span>
                            <span class="font-bold text-green-600">R$ ${(product.total_cost || 0).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTransferSuggestions(products) {
            const container = document.getElementById('transferSuggestions');

            // Logic: Find stores with LOW stock (< 5) and match with stores with HIGH stock (> 20) of same product
            const LOW_STOCK_THRESHOLD = 5;
            const HIGH_STOCK_THRESHOLD = 20;

            const suggestions = [];

            // Group products by code
            const productsByCode = {};
            products.forEach(p => {
                if (!productsByCode[p.product_code]) productsByCode[p.product_code] = [];
                productsByCode[p.product_code].push(p);
            });

            Object.entries(productsByCode).forEach(([code, items]) => {
                const lowStockStores = items.filter(i => (i.quantity || 0) <= LOW_STOCK_THRESHOLD);
                const highStockStores = items.filter(i => (i.quantity || 0) >= HIGH_STOCK_THRESHOLD);

                if (lowStockStores.length > 0 && highStockStores.length > 0) {
                    lowStockStores.forEach(low => {
                        // Find best source (highest stock)
                        const sources = highStockStores
                            .filter(h => h.store_id !== low.store_id)
                            .sort((a, b) => b.quantity - a.quantity);

                        if (sources.length > 0) {
                            suggestions.push({
                                product: low,
                                sources: sources
                            });
                        }
                    });
                }
            });

            if (suggestions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhuma sugestão de transferência baseada em estoque.</p>';
                return;
            }

            container.innerHTML = suggestions.slice(0, 10).map(s => {
                return `
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-3">
                        <h4 class="font-semibold text-gray-800 mb-1">${s.product.product_description || 'Produto ' + s.product.product_code}</h4>
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-semibold text-red-600">Estoque Baixo:</span> ${s.product.store_name} (${s.product.quantity} un)
                        </p>
                        <div class="flex flex-col gap-2 mt-2">
                            <span class="text-xs font-semibold text-gray-600">Sugerido transferir de:</span>
                            ${s.sources.map(source => `
                                <div class="flex justify-between items-center bg-white px-3 py-2 rounded border border-blue-100">
                                    <span class="text-sm text-gray-700">${source.store_name}</span>
                                    <span class="text-xs font-bold text-green-600">Estoque: ${source.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        loadData();
    </script>
</body>

</html>