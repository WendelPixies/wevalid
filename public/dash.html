<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeValid Dashboard</title>
    <link rel="icon" type="image/png" href="/perfume_icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/perfume_icon.png" alt="WeValid" class="w-10 h-10 invert">
                    <div>
                        <h1 class="text-xl font-bold">WeValid Dashboard</h1>
                        <p class="text-sm text-purple-100" id="userInfo">Carregando...</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Admin Controls -->
                    <div id="adminControls" class="hidden flex gap-2 mr-2 border-r pr-2 border-white/30">
                        <button onclick="openFranchiseModal()"
                            class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-all">
                            + Franquia
                        </button>
                        <button onclick="openStoreModal()"
                            class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-all">
                            + Loja
                        </button>
                    </div>

                    <a href="/import.html"
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                        Importar
                    </a>
                    <button onclick="logout()"
                        class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-all text-sm font-medium">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Franchise Filter (Admin only) -->
                <div id="franchiseFilterContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Franquia</label>
                    <select id="franchiseFilter" onchange="filterByFranchise()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Todas as Franquias</option>
                    </select>
                </div>

                <!-- Store Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Loja</label>
                    <select id="storeFilter" onchange="filterByStore()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="all">Todas as Lojas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Funcionários</div>
                <div class="text-2xl font-bold text-purple-600" id="totalUsers">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Produtos</div>
                <div class="text-2xl font-bold text-blue-600" id="totalProducts">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Vencendo em 7 dias</div>
                <div class="text-2xl font-bold text-amber-600" id="expiringProducts">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Custo Total</div>
                <div class="text-2xl font-bold text-green-600" id="totalCost">R$ 0</div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Employees -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Funcionários</h2>
                </div>
                <div id="employeesList" class="p-4 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 py-8">Carregando...</p>
                </div>
            </div>

            <!-- Products -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Produtos por Validade</h2>
                </div>
                <div id="productsList" class="p-4 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 py-8">Carregando...</p>
                </div>
            </div>

            <!-- Category Ranking -->
            <div class="bg-white rounded-lg shadow lg:col-span-2">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Ranking por Categoria</h2>
                </div>
                return names[role] || role;
                }

                function populateFranchiseFilter() {
                const select = document.getElementById('franchiseFilter');
                select.innerHTML = '<option value="all">Todas as Franquias</option>';
                allFranchises.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.name;
                select.appendChild(option);
                });
                }

                function populateStoreFilter() {
                const select = document.getElementById('storeFilter');
                select.innerHTML = '<option value="all">Todas as Lojas</option>';
                allStores.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                select.appendChild(option);
                });
                }

                window.filterByFranchise = async function () {
                const selectedFranchise = document.getElementById('franchiseFilter').value;
                if (selectedFranchise === 'all') {
                const { data: stores } = await supabase.from('stores').select('*').order('name');
                allStores = stores || [];
                } else {
                const { data: stores } = await supabase.from('stores').select('*').eq('franchise_id',
                selectedFranchise).order('name');
                allStores = stores || [];
                }
                populateStoreFilter();
                document.getElementById('storeFilter').value = 'all';
                await loadDashboardData();
                };

                window.filterByStore = async function () {
                updateDashboard();
                };

                // --- Admin Actions ---
                window.openFranchiseModal = function () {
                toggleModal('franchiseModal');
                }

                window.saveFranchise = async function () {
                const name = document.getElementById('franchiseName').value;
                if (!name) return alert('Nome obrigatório');

                const { error } = await supabase.from('franchises').insert({ name });
                if (error) alert('Erro: ' + error.message);
                else {
                alert('Franquia criada!');
                toggleModal('franchiseModal');
                location.reload();
                }
                }

                window.openStoreModal = function () {
                const select = document.getElementById('storeFranchiseSelect');
                select.innerHTML = allFranchises.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
                toggleModal('storeModal');
                }

                window.saveStore = async function () {
                const name = document.getElementById('storeName').value;
                const franchiseId = document.getElementById('storeFranchiseSelect').value;
                const pdv = document.getElementById('storePdv').value;

                if (!name || !franchiseId) return alert('Campos obrigatórios');

                const { error } = await supabase.from('stores').insert({ name, franchise_id: franchiseId, pdv_code: pdv
                });
                if (error) alert('Erro: ' + error.message);
                else {
                alert('Loja criada!');
                toggleModal('storeModal');
                location.reload();
                }
                }

                // --- User Edit Logic ---
                window.openUserModal = function (userId) {
                const user = allEmployees.find(e => e.id === userId);
                if (!user) return;

                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUserName').textContent = user.full_name;
                document.getElementById('editUserEmail').textContent = user.email;
                document.getElementById('editUserRole').value = user.role;

                // Populate Franchises
                const franchiseSelect = document.getElementById('editUserFranchise');
                franchiseSelect.innerHTML = '<option value="">Selecione...</option>' +
                allFranchises.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
                franchiseSelect.value = user.franchise_id || '';

                toggleUserFields();
                loadStoresForUser(user.stores.map(s => s.id));

                toggleModal('userModal');
                }

                window.toggleUserFields = function () {
                const role = document.getElementById('editUserRole').value;
                const franchiseField = document.getElementById('editFranchiseField');
                const storesField = document.getElementById('editStoresField');

                if (role === 'admin') {
                franchiseField.classList.add('hidden');
                storesField.classList.add('hidden');
                } else {
                franchiseField.classList.remove('hidden');
                if (role === 'store_user') storesField.classList.remove('hidden');
                else storesField.classList.add('hidden');
                }
                }

                window.loadStoresForUser = async function (selectedStoreIds = []) {
                const franchiseId = document.getElementById('editUserFranchise').value;
                const storesSelect = document.getElementById('editUserStores');
                storesSelect.innerHTML = '';

                if (!franchiseId) return;

                const { data: stores } = await supabase.from('stores').select('*').eq('franchise_id',
                franchiseId).order('name');
                if (stores) {
                storesSelect.innerHTML = stores.map(s => {
                const selected = selectedStoreIds.includes(s.id) ? 'selected' : '';
                return `<option value="${s.id}" ${selected}>${s.name}</option>`;
                }).join('');
                }
                }

                window.saveUser = async function () {
                const userId = document.getElementById('editUserId').value;
                const role = document.getElementById('editUserRole').value;
                const franchiseId = document.getElementById('editUserFranchise').value;

                const updates = { role };
                if (role !== 'admin') updates.franchise_id = franchiseId;
                else updates.franchise_id = null;

                // Update Profile
                const { error } = await supabase.from('user_profiles').update(updates).eq('id', userId);
                if (error) return alert('Erro ao atualizar perfil: ' + error.message);

                // Update Stores if store_user
                if (role === 'store_user') {
                const selectedOptions = document.getElementById('editUserStores').selectedOptions;
                const storeIds = Array.from(selectedOptions).map(opt => opt.value);

                // Delete old
                await supabase.from('user_stores').delete().eq('user_id', userId);

                // Insert new
                if (storeIds.length > 0) {
                const { error: storeError } = await supabase.from('user_stores').insert(
                storeIds.map(sid => ({ user_id: userId, store_id: sid }))
                );
                if (storeError) alert('Erro ao atualizar lojas: ' + storeError.message);
                }
                }

                alert('Usuário atualizado!');
                toggleModal('userModal');
                location.reload();
                }

                // --- Modal Utils ---
                window.toggleModal = function (modalID) {
                const modal = document.getElementById(modalID);
                modal.classList.toggle('opacity-0');
                modal.classList.toggle('pointer-events-none');
                document.body.classList.toggle('modal-active');
                }

                window.closeModal = function (modalID) {
                toggleModal(modalID);
                }

                // Close on overlay click
                document.querySelectorAll('.modal-overlay').forEach(el => {
                el.addEventListener('click', function () {
                const modal = el.closest('.modal');
                toggleModal(modal.id);
                });
                });

                loadData();
                </script>
</body>

</html>